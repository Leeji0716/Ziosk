<!DOCTYPE html>
<html layout:decorate="~{layout}" lang="en" xmlns:layout="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.w3.org/1999/xhtml" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>주문 목록</title>
</head>
<body>
<div layout:fragment="content" class="col-6 h-[90vh]">
    <div class="row my-3 h-[5%]">
        <div class="col-6">
            <a th:if="${#authorization.expression('isAuthenticated()')}" th:href="@{|/product/create|}" class="btn btn-primary">제품 등록하기</a>
        </div>
        <div class="navbar bg-base-100">
            <div class="flex-1 justify-center">
                <a class="btn btn-ghost text-xs" th:href="@{|/product/list|}">전체</a>
                <div th:each="category : ${categoryList}">
                    <a class="btn btn-ghost text-xs" th:href="@{|/product/list?categoryId=${category.id}|}" th:text="${category.name}"></a>
                </div>
            </div>
            <a th:if="${#authorization.expression('isAuthenticated()')}" th:href="@{|/category/create|}" class="btn btn-primary">카테고리 추가</a>
        </div>
    </div>
    <div class="row flex justify-around flex-wrap overflow-y-auto h-[60%]">
        <div th:each="product : ${productList}" class="col-4">
            <a th:id="|product_${product.id}|"></a>
            <div class="card w-96 bg-base-100 shadow-xl">
                <figure class="px-10 pt-10">
                    <img th:src="${product.image}" alt="Empty" class="rounded-xl" width="100" height="200"/>
                </figure>
                <div class="card-body items-center text-center">
                    <h2 class="card-title" th:text="${product.productName}"></h2>
                    <p class="card-text product-price" th:text="${product.price} + '원'"></p>
                    <div class="card-actions">
                        <button sec:authorize="isAnonymous()" class="btn btn-accent" th:attr="onclick='openModal(\'' + ${product.id} + '\')'">담기</button>
                        <a sec:authorize="isAuthenticated()" th:href="@{|/product/modify/${product.id}|}" class="btn btn-primary">수정</a>
                        <a sec:authorize="isAuthenticated()" href="javascript:void(0);" th:data-uri="@{|/product/delete/${product.id}|}" class="delete btn btn-error">삭제</a>
                    </div>
                </div>

                <!-- 각 제품에 대한 모달 -->
                <dialog th:id="@{|my_modal_${product.id}|}" class="modal">
                    <div class="modal-box w-[800px] max-w-5xl">
                        <div class="flex justify-center">
                            <div class="card w-96 bg-base-100 shadow-xl">
                                <figure class="px-10 pt-10">
                                    <img th:src="${product.image}" alt="Empty" class="rounded-xl" width="100" height="200"/>
                                </figure>
                                <div class="card-body items-center text-center">
                                    <h2 class="card-title" th:text="${product.productName}"></h2>
                                    <p class="card-text product-price" th:text="${product.price} + '원'"></p>
                                </div>
                            </div>
                            <table class="table">
                                <thead>
                                <tr class="text-center">
                                    <th>번호</th>
                                    <th style="width:50%">항목</th>
                                    <th>가격</th>
                                    <th>수량</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr class="text-center item-row" th:each="item, index : ${product.itemList}">
                                    <td th:text="${index.index + 1}"></td>
                                    <td th:text="${item.content}"></td>
                                    <td th:id="${'item-price_' + item.id}" class="item-price" th:text="${item.price} + '원'"></td>
                                    <td>
                                        <button th:data-index="${item.id}" th:data-product-id="${product.id}" onclick="decreaseItem(this)" class="btn btn-xs btn-outline btn-error">-</button>
                                        <span th:id="${'itemQuantity_' + item.id}" class="item-quantity">0</span> <!-- 수량 표시 -->
                                        <button th:data-index="${item.id}" th:data-product-id="${product.id}" onclick="increaseItem(this)" class="btn btn-xs btn-outline btn-success">+</button>
                                        <span th:id="${'totalPricePerItem_' + item.id}" th:data-total-price="${totalPricePerItem}" class="totalPricePerItem" hidden></span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="navbar bg-green-100 h-[20%]">
                            <div class="flex-1 justify-start">
                                <span class="text-2xl font-bold">총 가격</span>
                            </div>
                            <div class="flex-1 justify-center">
                                <span class="text-2xl font-bold" th:id="${'orderPrice_' + product.id}"></span>
                            </div>
                            <div class="col-6">
                                <a sec:authorize="isAnonymous()" class="btn btn-accent" th:data-pid="${product.id}" th:id="@{|add-item_${product.id}|}">담기</a>
                            </div>
                        </div>
                        <div class="modal-action col-6">
                            <form method="dialog">
                                <button class="btn">Close</button>
                            </form>
                        </div>
                    </div>
                </dialog>
            </div>
        </div>
    </div>
    <div class="border border-green-200 border-4 rounded-lg h-[40%]">
        <div class="navbar bg-green-50 h-[20%]">
            <div class="justify-center">
                <button class="btn btn-ghost text-2xl">장바구니</button>
            </div>
            <div class="col-6">
                <a href="/product/reset" class="btn btn-primary">장바구니 비우기</a>
            </div>
        </div>
        <div class="bg-green-50 overflow-auto h-[60%]">
            <table class="table" style="max-height: 100%;">
                <thead>
                <tr class="text-center">
                    <th>번호</th>
                    <th style="width:50%">상품명</th>
                    <th>가격</th>
                    <th>수량</th>
                    <th>금액</th>
                </tr>
                </thead>
                <tbody>
                <tr class="text-center product-row" th:each="select, index : ${selectList}">
                    <td th:text="${index.index + 1}"></td>
                    <td class="product-name" th:text="${select.productName}"></td>
                    <td th:id="${'product_price_' + index.index}" class="product-price" th:text="${select.total} + '원'"></td>
                    <td>
                        <button th:data-index="${index.index}" onclick="decreaseQuantity(this)" class="btn btn-xs btn-outline btn-error">-</button>
                        <span th:id="${'quantity_' + index.index}" class="product-quantity">1</span> <!-- 수량 표시 -->
                        <button th:data-index="${index.index}" onclick="increaseQuantity(this)" class="btn btn-xs btn-outline btn-success">+</button>
                    </td>
                    <td th:id="${'totalPricePerProduct_' + index.index}" class="totalPricePerProduct"></td>
                    <td>
                        <a th:href="@{|/product/show/${index.index}|}" class="btn btn-xs btn-outline btn-success">+</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="navbar bg-green-100 h-[20%]">
            <div class="flex-1 justify-start">
                <span class="text-2xl font-bold">총 상품 가격</span>
            </div>
            <div class="flex-1 justify-center">
                <span id="totalPrice" class="text-2xl font-bold"></span>
            </div>
            <div class="col-6">
                <button id="payButton" class="btn btn-primary">결제</button>
            </div>
        </div>
    </div>
    <script>
        // -버튼 클릭 시
        function decreaseItem(element) {
            var selectItem = element.dataset.index;
            var productId = element.dataset.productId;
            var quantityElement = document.getElementById('itemQuantity_' + selectItem);
            var currentQuantity = parseInt(quantityElement.innerText);

            if (currentQuantity > 0) {
                currentQuantity -= 1; // 현재 수량에서 1을 빼기
                quantityElement.innerText = currentQuantity; // 업데이트된 수량을 화면에 표시
            }
            updateItem(selectItem, productId);
        }

        // +버튼 클릭 시
        function increaseItem(element) {
            var selectItem = element.dataset.index;
            var productId = element.dataset.productId;
            var quantityElement = document.getElementById('itemQuantity_' + selectItem);
            var currentQuantity = parseInt(quantityElement.innerText);

            currentQuantity += 1; // 현재 수량에 1을 더하기
            quantityElement.innerText = currentQuantity; // 업데이트된 수량을 화면에 표시

            updateItem(selectItem, productId);
        }

        function updateItem(selectItem, productId) {
            var priceElement = document.getElementById('item-price_' + selectItem);
            var quantityElement = document.getElementById('itemQuantity_' + selectItem);

            var price = parseInt(priceElement.innerText) || 0;
            var quantity = parseInt(quantityElement.innerText) || 0;

            var totalPricePerItem = price * quantity;

            var targetId = 'totalPricePerItem_' + selectItem;
            var targetElement = document.getElementById(targetId);
            targetElement.innerText = totalPricePerItem + '원';

            targetElement.setAttribute('data-total-price', totalPricePerItem);

            calculateOrderPrice(productId);
        }

        function calculateOrderPrice(productId) {
            var modal = document.getElementById('my_modal_' + productId);
            var productPrice = parseFloat(modal.querySelector(".product-price").innerText.replace("원", "")) || 0;
            var orderPrice = productPrice;

            var itemRows = document.querySelectorAll(".item-row");
            itemRows.forEach(function(row) {
                var totalPricePerItem = parseInt(row.querySelector(".totalPricePerItem").innerText.replace("원", "")) || 0;
                orderPrice += totalPricePerItem;
            });
            var formattedPrice = orderPrice.toLocaleString(); // 콤마를 포함한 형식으로 변환
            document.getElementById('orderPrice_' + productId).innerText = formattedPrice + '원';
        }


        // -버튼 클릭 시
        function decreaseQuantity(element) {
            var selectIndex = element.dataset.index;
            var quantityElement = document.getElementById('quantity_' + selectIndex);
            var currentQuantity = parseInt(quantityElement.innerText);

            if (currentQuantity > 0) {
                currentQuantity -= 1; // 현재 수량에서 1을 빼기
                quantityElement.innerText = currentQuantity; // 업데이트된 수량을 화면에 표시
            }
            update(selectIndex);
        }

        // +버튼 클릭 시
        function increaseQuantity(element) {
            var selectIndex = element.dataset.index;
            var quantityElement = document.getElementById('quantity_' + selectIndex);
            var currentQuantity = parseInt(quantityElement.innerText);

            currentQuantity += 1; // 현재 수량에 1을 더하기
            quantityElement.innerText = currentQuantity; // 업데이트된 수량을 화면에 표시
            update(selectIndex);
        }

        function update(selectIndex) { //totalPricePerProduct
            var priceElement = document.getElementById('product_price_' + selectIndex);
            var quantityElement = document.getElementById('quantity_' + selectIndex);

            var price = parseInt(priceElement.innerText);
            var quantity = parseInt(quantityElement.innerText);

            var totalPricePerProduct = price * quantity;

            var targetId = 'totalPricePerProduct_' + selectIndex;
            console.log(targetId);
            var targetElement = document.getElementById(targetId);
            var formattedtotalPricePerProduct = totalPricePerProduct.toLocaleString(); // 콤마를 포함한 형식으로 변환
            targetElement.innerText = formattedtotalPricePerProduct + "원";
<!--            targetElement.innerText = totalPricePerProduct + '원';-->

            calculateTotalPrice();
        }

        function calculateTotalPrice() { //totalPrice
            var totalPrice = 0;
            var productRows = document.querySelectorAll(".product-row");
            productRows.forEach(function(row) {
                var price = parseInt(row.querySelector(".product-price").innerText.replace("원", "")) || 0;
                var quantity = parseInt(row.querySelector(".product-quantity").innerText) || 0;
                totalPrice += price * quantity;
            });
            var formattedPrice = totalPrice.toLocaleString(); // 콤마를 포함한 형식으로 변환
            document.getElementById("totalPrice").innerText = formattedPrice + "원";
        }

        function openModal(productId) {
            var modal = document.getElementById('my_modal_' + productId);
            modal.showModal();
            calculateOrderPrice(productId); // 모달을 열 때 주문 가격 계산
        }

        function closeModal(productId) {
            var modal = document.getElementById('my_modal_' + productId);
            modal.close();
        }

        document.addEventListener('DOMContentLoaded', function() {
            calculateTotalPrice();
        });

        document.querySelectorAll("[id^='add-item_']").forEach(function(elem) {
            elem.addEventListener("click", function(e){
                e.preventDefault();
                const pid = e.target.dataset.pid;
                const priceText = document.getElementById('orderPrice_' + pid).innerText;
                const price = parseInt(priceText.replace(/[^0-9]/g, ''), 10); // 숫자만 추출하여 정수로 변환
                console.log(price);
                location.href = `/item/select/${pid}?orderPrice=${price}`;
            });
        });

        document.getElementById("payButton").addEventListener("click", function(event) {
            // totalPrice를 가져와서 콤마를 제거하고 숫자로 변환
            var totalPriceString = document.getElementById("totalPrice").innerText;
            var totalPriceNumber = parseInt(totalPriceString.replace(/,/g, ''), 10);

            IMP.init('imp07531670'); // 아임포트에서 발급받은 가맹점 식별코드로 초기화합니다.

            event.preventDefault(); // 기본 동작(폼 전송)을 중지

            // 결제 요청 정보 설정
            var payReq = {
                pg: 'html5_inicis',
                pay_method: 'card',
                merchant_uid: 'merchant_' + new Date().getTime(),
                name: '주문명:Ziosk',
                amount: totalPriceNumber,
                buyer_postcode: '',
                m_redirect_url: 'http://localhost:8088/product/success' // 모바일에서 결제 완료 후 리디렉션 될 URL
            };

            // 결제 요청 수행
            IMP.request_pay(payReq, function(response) {
                if (response.success) {
                    console.log(response);
                    window.location.href = payReq.m_redirect_url;
                } else {
                    alert('결제실패 : ' + response.error_msg);
                    // 결제 실패 시 추가적인 처리를 수행
                }
            });
        });
    </script>
</div>
</body>
</html>
